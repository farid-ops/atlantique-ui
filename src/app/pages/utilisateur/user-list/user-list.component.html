<div class="row">
  <div class="col-sm-12">
    <app-card cardTitle="Gestion des Utilisateurs" [options]="false">

      <ng-container *ngIf="isFormVisible">
        <h4>{{ isEditMode ? 'Modifier un Utilisateur' : 'Créer un Utilisateur' }}</h4>
        <form (ngSubmit)="submitUtilisateur()" #utilisateurForm="ngForm">
          <div *ngIf="errorMessage" class="alert alert-danger mb-3">
            {{ errorMessage }}
          </div>

          <h5 class="mb-3">Informations Générales de l'Utilisateur</h5>
          <div class="row">
            <div class="form-group col-md-6">
              <label for="nom">Nom: <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="nom" name="nom" [(ngModel)]="currentFormData.nom" required [readonly]="!canEditUserFields()">
            </div>
            <div class="form-group col-md-6">
              <label for="prenom">Prénom: <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="prenom" name="prenom" [(ngModel)]="currentFormData.prenom" required [readonly]="!canEditUserFields()">
            </div>
          </div>

          <div class="row">
            <div class="form-group col-md-6">
              <label for="email">Email: <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="email" name="email" [(ngModel)]="currentFormData.email" required [readonly]="!canEditUserFields()">
            </div>
            <div class="form-group col-md-6">
              <label for="telephone">Téléphone: <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="telephone" name="telephone" [(ngModel)]="currentFormData.telephone" required [readonly]="!canEditUserFields()">
            </div>
          </div>

          <div class="row">
            <div class="form-group col-md-12">
              <label for="adresse">Adresse: <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="adresse" name="adresse" [(ngModel)]="currentFormData.adresse" required [readonly]="!canEditUserFields()">
            </div>
          </div>

          <h5 class="mt-4 mb-3">Affectation Géographique et Groupe</h5>
          <div class="row">
            <div class="form-group col-md-6">
              <label for="idPays">Pays: <span class="text-danger">*</span></label>
              <select class="form-control" id="idPays" name="idPays" [(ngModel)]="currentFormData.idPays" (change)="onPaysSelected($event)" required [disabled]="!canEditUserFields()">
                <option [value]="''" disabled>Sélectionner un pays</option>
                @for (pays of paysList; track pays.id) {
                  <option [value]="pays.id">{{ pays.designation }}</option>
                }
              </select>
            </div>
            <div class="form-group col-md-6">
              <label for="idSite">Site (Port): <span class="text-danger">*</span></label>
              <select class="form-control" id="idSite" name="idSite" [(ngModel)]="currentFormData.idSite" required [disabled]="!canEditUserFields()">
                <option [value]="''" disabled>Sélectionner un site (port)</option>
                @for (port of filteredPortsList; track port.id) {
                  <option [value]="port.id">{{ port.designation }}</option>
                }
              </select>
            </div>
          </div>

          <div class="row">
            <div class="form-group col-md-12">
              <label for="idGroupe">Groupe: <span class="text-danger">*</span></label>
              <select class="form-control" id="idGroupe" name="idGroupe" [(ngModel)]="currentFormData.idGroupe" required [disabled]="!canEditUserFields()">
                <option [value]="''" disabled>Sélectionner un groupe</option>
                @for (groupe of groupesList; track groupe.id) {
                  <option [value]="groupe.id">{{ groupe.denomination }}</option>
                }
              </select>
            </div>
          </div>

          <h5 class="mt-4 mb-3">Rôles et Sécurité</h5>
          <div class="form-group">
            <label>Rôles: <span class="text-danger">*</span></label>
            <div class="row">
              @for (autorite of autoritesList; track autorite.id) {
                <div class="col-md-4 col-sm-6 col-12">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [id]="'role-' + autorite.id"
                      [value]="autorite.id"
                      [checked]="isRoleSelected(autorite.id!)"
                      (change)="onRoleCheckboxChange(autorite.id!, $event)"
                      name="roles"
                      [disabled]="!canEditUserFields()"
                    >
                    <label class="form-check-label" [for]="'role-' + autorite.id">
                      {{ autorite.nom }}
                    </label>
                  </div>
                </div>
              }
            </div>
            <div *ngIf="currentFormData.autoriteIds && currentFormData.autoriteIds.length === 0 && utilisateurForm.submitted" class="text-danger mt-2">
              Au moins un rôle est obligatoire.
            </div>
          </div>

          <div class="form-group" *ngIf="!isEditMode || canEditUserFields()">
            <label for="password">Mot de passe:</label>
            <input type="password" class="form-control" id="password" name="password" [(ngModel)]="currentFormData.password"
                   [readonly]="!canEditUserFields()" [disabled]="!canEditUserFields()" [required]="!isEditMode">
          </div>

          <div class="form-group">
            <label for="enabled">Statut</label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="enabled" name="enabled" [(ngModel)]="currentFormData.enabled"
                     [disabled]="!canEditUserFields()">
              <label class="form-check-label" for="enabled">{{ currentFormData.enabled ? 'Actif' : 'Inactif' }}</label>
            </div>
          </div>

          <div class="d-flex justify-content-end mt-4">
            <button type="button" class="btn btn-secondary me-2" (click)="cancelEdit()">Annuler</button>
            <button type="submit" class="btn btn-primary" [disabled]="loading || utilisateurForm.invalid || (currentFormData.autoriteIds && currentFormData.autoriteIds.length === 0)">
              <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              {{ isEditMode ? 'Mettre à jour' : 'Créer' }}
            </button>
          </div>
        </form>
      </ng-container>

      <ng-container *ngIf="!isFormVisible">
        <h4 class="mt-5">Liste des Utilisateurs</h4>
        <button *ngIf="currentUserRoles.has('ADMIN')" class="btn btn-success mb-3" (click)="createNewUtilisateur()">
          <i class="feather icon-plus"></i> Créer un nouvel Utilisateur
        </button>

        <div class="table-responsive mt-4">
          <div *ngIf="loading" class="text-center">
            Chargement des utilisateurs...
          </div>
          <div *ngIf="errorMessage && !loading" class="alert alert-danger mb-3">
            {{ errorMessage }}
          </div>

          <table class="table table-hover" *ngIf="utilisateurs.length > 0 && !loading">
            <thead>
            <tr>
              <th (click)="onSortChangeClick('nom')">Nom <i *ngIf="sortBy === 'nom'" [class]="sortDirection === 'asc' ? 'feather icon-arrow-up' : 'feather icon-arrow-down'"></i></th>
              <th (click)="onSortChangeClick('prenom')">Prénom <i *ngIf="sortBy === 'prenom'" [class]="sortDirection === 'asc' ? 'feather icon-arrow-up' : 'feather icon-arrow-down'"></i></th>
              <th (click)="onSortChangeClick('email')">Email <i *ngIf="sortBy === 'email'" [class]="sortDirection === 'asc' ? 'feather icon-arrow-up' : 'feather icon-arrow-down'"></i></th>
              <th (click)="onSortChangeClick('telephone')">Téléphone <i *ngIf="sortBy === 'telephone'" [class]="sortDirection === 'asc' ? 'feather icon-arrow-up' : 'feather icon-arrow-down'"></i></th>
              <th (click)="onSortChangeClick('idPays')">Pays <i *ngIf="sortBy === 'idPays'" [class]="sortDirection === 'asc' ? 'feather icon-arrow-up' : 'feather icon-arrow-down'"></i></th>
              <th (click)="onSortChangeClick('idSite')">Site (Port) <i *ngIf="sortBy === 'idSite'" [class]="sortDirection === 'asc' ? 'feather icon-arrow-up' : 'feather icon-arrow-down'"></i></th>
              <th (click)="onSortChangeClick('idGroupe')">Groupe <i *ngIf="sortBy === 'idGroupe'" [class]="sortDirection === 'asc' ? 'feather icon-arrow-up' : 'feather icon-arrow-down'"></i></th>
              <th>Rôles</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody>
              @for (user of utilisateurs; track user.id) {
                <tr>
                  <td>{{ user.nom }}</td>
                  <td>{{ user.prenom }}</td>
                  <td>{{ user.email }}</td>
                  <td>{{ user.telephone }}</td>
                  <td>{{ getPaysDesignation(user.idPays) }}</td>
                  <td>{{ getPortDesignation(user.idSite) }}</td>
                  <td>{{ getGroupeDenomination(user.idGroupe) }}</td>
                  <td>{{ getRoleNames(user.authorites) }}</td>
                  <td>
                    <span class="badge" [ngClass]="user.enabled ? 'bg-success' : 'bg-danger'">
                      {{ user.enabled ? 'Actif' : 'Inactif' }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-info btn-sm me-2" (click)="editUtilisateur(user)"
                            *ngIf="canEditUser(user)">Modifier</button>
                    <button class="btn btn-danger btn-sm me-2" (click)="deleteUtilisateur(user.id!)"
                            *ngIf="canDeleteUser(user)">Supprimer</button>
                    <button [routerLink]="['/utilisateurs', user.id, 'details']" class="btn btn-sm btn-info me-2">
                      Détails
                    </button>
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="10" class="text-center">Aucun utilisateur trouvé.</td>
                </tr>
              }
            </tbody>
          </table>

          <div *ngIf="utilisateurs.length === 0 && !loading && !errorMessage" class="alert alert-info mt-3">
            Aucun utilisateur trouvé.
          </div>

          <div class="d-flex justify-content-between align-items-center mt-3" *ngIf="totalPages > 0">
            <div>
              Page {{ currentPage + 1 }} sur {{ totalPages }} ({{ totalElements }} utilisateurs au total)
            </div>
            <div>
              Éléments par page:
              <select class="form-select form-select-sm d-inline-block w-auto ms-2" [(ngModel)]="pageSize" (change)="onPageSizeChange($event)" name="pageSizeSelect">
                <option [value]="5">5</option>
                <option [value]="10">10</option>
                <option [value]="20">20</option>
                <option [value]="50">50</option>
              </select>
            </div>
            <nav aria-label="Page navigation example">
              <ul class="pagination mb-0">
                <li class="page-item" [class.disabled]="currentPage === 0">
                  <a class="page-link" href="javascript:void(0)" (click)="onPageChangeClick(0)">Première</a>
                </li>
                <li class="page-item" [class.disabled]="currentPage === 0">
                  <a class="page-link" href="javascript:void(0)" (click)="onPageChangeClick(currentPage - 1)">Précédent</a>
                </li>

                @for (page of getPagesArray(); track page) {
                  <li class="page-item" [class.active]="page === currentPage" [class.disabled]="page === '...' ">
                    <a class="page-link" href="javascript:void(0)" (click)="onPageChangeClick(page)">
                      {{ getDisplayPageNumber(page) }}
                    </a>
                  </li>
                }

                <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
                  <a class="page-link" href="javascript:void(0)" (click)="onPageChangeClick(totalPages - 1)">Dernière</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </ng-container>
    </app-card>
  </div>
</div>
