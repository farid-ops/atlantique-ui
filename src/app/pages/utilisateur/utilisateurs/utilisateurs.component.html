<div class="row">
  <div class="col-sm-12">
    <app-card [cardTitle]="utilisateurId ? 'Modifier un Utilisateur' : 'Créer un Utilisateur'" [options]="false">
      <div class="card-body">
        <div *ngIf="errorMessage" class="alert alert-danger mb-3">
          {{ errorMessage }}
        </div>

        <form (ngSubmit)="submitUtilisateur()" #utilisateurForm="ngForm">
          <h5 class="mb-3">Informations Générales de l'Utilisateur</h5>
          <div class="row">
            <div class="form-group col-md-6">
              <label for="nom">Nom: <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="nom" name="nom" [(ngModel)]="currentFormData.nom" required [readonly]="!canEditUserFields()">
            </div>
            <div class="form-group col-md-6">
              <label for="prenom">Prénom: <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="prenom" name="prenom" [(ngModel)]="currentFormData.prenom" required [readonly]="!canEditUserFields()">
            </div>
          </div>

          <div class="row">
            <div class="form-group col-md-6">
              <label for="email">Email: <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="email" name="email" [(ngModel)]="currentFormData.email" required [readonly]="!canEditUserFields()">
            </div>
            <div class="form-group col-md-6">
              <label for="telephone">Téléphone: <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="telephone" name="telephone" [(ngModel)]="currentFormData.telephone" required [readonly]="!canEditUserFields()">
            </div>
          </div>

          <div class="row">
            <div class="form-group col-md-12">
              <label for="adresse">Adresse: <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="adresse" name="adresse" [(ngModel)]="currentFormData.adresse" required [readonly]="!canEditUserFields()">
            </div>
          </div>

          <h5 class="mt-4 mb-3">Affectation Géographique et Groupe</h5>
          <div class="row">
            <div class="form-group col-md-6">
              <label for="idPays">Pays: <span class="text-danger">*</span></label>
              <select class="form-control" id="idPays" name="idPays" [(ngModel)]="currentFormData.idPays" (change)="onPaysSelected($event)" required [disabled]="!canEditUserFields()">
                <option [value]="''" disabled>Sélectionner un pays</option>
                @for (pays of paysList; track pays.id) {
                  <option [value]="pays.id">{{ pays.designation }}</option>
                }
              </select>
            </div>
            <div class="form-group col-md-6">
              <label for="idSite">Site (Port): <span class="text-danger">*</span></label>
              <select class="form-control" id="idSite" name="idSite" [(ngModel)]="currentFormData.idSite" required [disabled]="!canEditUserFields()">
                <option [value]="''" disabled>Sélectionner un site (port)</option>
                @for (port of filteredPortsList; track port.id) {
                  <option [value]="port.id">{{ port.designation }}</option>
                }
              </select>
            </div>
          </div>

          <div class="row">
            <div class="form-group col-md-12">
              <label for="idGroupe">Groupe: <span class="text-danger">*</span></label>
              <select class="form-control" id="idGroupe" name="idGroupe" [(ngModel)]="currentFormData.idGroupe" required [disabled]="!canEditUserFields()">
                <option [value]="''" disabled>Sélectionner un groupe</option>
                @for (groupe of groupesList; track groupe.id) {
                  <option [value]="groupe.id">{{ groupe.denomination }}</option>
                }
              </select>
            </div>
          </div>

          <h5 class="mt-4 mb-3">Rôles et Sécurité</h5>
          <div class="form-group">
            <label>Rôles: <span class="text-danger">*</span></label>
            <div class="row">
              @for (autorite of autoritesList; track autorite.id) {
                <div class="col-md-4 col-sm-6 col-12">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [id]="'role-' + autorite.id"
                      [value]="autorite.id"
                      [checked]="isRoleSelected(autorite.id!)"
                      (change)="onRoleCheckboxChange(autorite.id!, $event)"
                      name="roles"
                      [disabled]="!canEditUserFields()"
                    >
                    <label class="form-check-label" [for]="'role-' + autorite.id">
                      {{ autorite.nom }}
                    </label>
                  </div>
                </div>
              }
            </div>
            <div *ngIf="currentFormData.autoriteIds && currentFormData.autoriteIds.length === 0" class="text-danger mt-2">
              Au moins un rôle est obligatoire.
            </div>
          </div>

          <div class="form-group" *ngIf="!isEditMode || canEditUserFields()">
            <label for="password">Mot de passe:</label>
            <input id="password" type="password" class="form-control"
                   [(ngModel)]="currentFormData.password" name="password" [readonly]="!canEditUserFields()" [disabled]="!canEditUserFields()"
                   [required]="!isEditMode"> </div>

          <div class="form-group">
            <label for="enabled">Statut</label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="enabled" name="enabled" [(ngModel)]="currentFormData.enabled"
                     [disabled]="!canEditUserFields()">
              <label class="form-check-label" for="enabled">{{ currentFormData.enabled ? 'Actif' : 'Inactif' }}</label>
            </div>
          </div>

          <div class="d-flex justify-content-end mt-4">
            <button type="button" class="btn btn-secondary me-2" (click)="cancel()">Annuler</button>
            <button type="submit" class="btn btn-primary" [disabled]="loading || utilisateurForm.invalid">
              <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              {{ isEditMode ? 'Mettre à jour' : 'Créer' }}
            </button>
          </div>
        </form>

        <div *ngIf="errorMessage" class="alert alert-danger mt-3">
          {{ errorMessage }}
        </div>
      </div>
    </app-card>
  </div>
</div>
